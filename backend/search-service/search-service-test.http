### =============================================================
### SEARCH SERVICE - HTTP Test File
### Travel Platform - Elasticsearch Search API
### =============================================================
### NOTE: Le search-service est un service CQRS Read-Side.
### Il ne cr√©e PAS de donn√©es ‚Äî les documents sont index√©s
### automatiquement via RabbitMQ quand un manager publie un voyage
### depuis le travel-service.
###
### Flux de test complet :
### 1. Se connecter (auth-service)
### 2. Cr√©er et publier un voyage (travel-service) ‚Üí d√©clenche l'indexation
### 3. Rechercher le voyage (search-service)
### =============================================================

### Base URLs
@authBaseUrl = http://localhost:8081/api/v1
@travelBaseUrl = http://localhost:8082/api/v1
@searchBaseUrl = http://localhost:8085/api/v1

### =============================================================
### STEP 1: AUTHENTICATE (get tokens from auth-service)
### =============================================================

### ----- Login as Manager -----
# @name loginManager
POST {{authBaseUrl}}/auth/login
Content-Type: application/json

{
    "email": "manager@travel.sn",
    "password": "Password123!"
}

### ----- Login as Traveler -----
# @name loginTraveler
POST {{authBaseUrl}}/auth/login
Content-Type: application/json

{
    "email": "traveler@travel.sn",
    "password": "Password123!"
}

### Variables (populated from login responses)
@managerToken = {{loginManager.response.body.accessToken}}
@travelerToken = {{loginTraveler.response.body.accessToken}}

### =============================================================
### STEP 2: CREATE & PUBLISH TRAVELS (triggers search indexing!)
### =============================================================
### ‚ö° Quand un voyage est publi√©, le travel-service envoie un
### TravelCreatedEvent via RabbitMQ ‚Üí le search-service l'indexe
### dans Elasticsearch automatiquement.
### =============================================================

### ----- Create Travel 1: Senegal Beach Trip -----
# @name createTravel1
POST {{travelBaseUrl}}/travels
Authorization: Bearer {{managerToken}}
Content-Type: application/json

{
    "title": "Escapade √† Saint-Louis",
    "description": "D√©couvrez la magnifique ville de Saint-Louis du S√©n√©gal, avec ses plages dor√©es, son architecture coloniale et sa culture vibrante. Balade en pirogue sur le fleuve S√©n√©gal.",
    "startDate": "2026-04-15",
    "endDate": "2026-04-22",
    "price": 450000.0,
    "maxCapacity": 20,
    "accommodationType": "HOTEL",
    "accommodationName": "H√¥tel de la Poste",
    "transportationType": "BUS",
    "transportationDetails": "Bus climatis√© Dakar ‚Üí Saint-Louis (aller-retour)",
    "destinations": [
        {
            "name": "Saint-Louis",
            "country": "S√©n√©gal",
            "city": "Saint-Louis",
            "description": "Ancienne capitale du S√©n√©gal, patrimoine UNESCO"
        },
        {
            "name": "Langue de Barbarie",
            "country": "S√©n√©gal",
            "city": "Saint-Louis",
            "description": "Parc national et plage sauvage"
        }
    ],
    "activities": [
        {
            "name": "Balade en pirogue",
            "description": "Tour en pirogue sur le fleuve S√©n√©gal",
            "location": "Fleuve S√©n√©gal"
        },
        {
            "name": "Visite du quartier des p√™cheurs",
            "description": "D√©couverte de Guet Ndar, le quartier des p√™cheurs",
            "location": "Guet Ndar, Saint-Louis"
        }
    ]
}

@travelId1 = {{createTravel1.response.body.id}}

### ----- Create Travel 2: Casamance Adventure -----
# @name createTravel2
POST {{travelBaseUrl}}/travels
Authorization: Bearer {{managerToken}}
Content-Type: application/json

{
    "title": "Aventure en Casamance",
    "description": "Explorez la Casamance, r√©gion verdoyante du sud du S√©n√©gal. For√™ts tropicales, plages paradisiaques et rencontre avec la culture Diola.",
    "startDate": "2026-05-10",
    "endDate": "2026-05-18",
    "price": 650000.0,
    "maxCapacity": 15,
    "accommodationType": "GUESTHOUSE",
    "accommodationName": "Le Fromager",
    "transportationType": "FLIGHT",
    "transportationDetails": "Vol Air S√©n√©gal Dakar ‚Üí Ziguinchor",
    "destinations": [
        {
            "name": "Cap Skirring",
            "country": "S√©n√©gal",
            "city": "Ziguinchor",
            "description": "Station baln√©aire avec plages de sable fin"
        },
        {
            "name": "√éle de Karabane",
            "country": "S√©n√©gal",
            "city": "Casamance",
            "description": "√éle tropicale accessible uniquement par pirogue"
        }
    ],
    "activities": [
        {
            "name": "Randonn√©e en for√™t",
            "description": "Trek dans la for√™t tropicale de Casamance",
            "location": "For√™t de Casamance"
        },
        {
            "name": "Observation des oiseaux",
            "description": "Birdwatching dans le parc de la Basse Casamance",
            "location": "Parc de la Basse Casamance"
        }
    ]
}

@travelId2 = {{createTravel2.response.body.id}}

### ----- Publish Travel 1 (triggers TravelCreatedEvent ‚Üí search indexing!) -----
# @name publishTravel1
POST {{travelBaseUrl}}/travels/{{travelId1}}/publish
Authorization: Bearer {{managerToken}}

### ----- Publish Travel 2 (triggers TravelCreatedEvent ‚Üí search indexing!) -----
# @name publishTravel2
POST {{travelBaseUrl}}/travels/{{travelId2}}/publish
Authorization: Bearer {{managerToken}}

### ‚è≥ Attendez ~1 seconde que le search-service indexe les documents

### =============================================================
### STEP 3: SEARCH (the fun part! üîç)
### =============================================================

### ----- Search all (no query) ‚Üí returns all published travels -----
GET {{searchBaseUrl}}/search?page=0&size=10

### ----- Full-text search: "Saint-Louis" -----
GET {{searchBaseUrl}}/search?q=Saint-Louis&page=0&size=10

### ----- Full-text search: "beach" (fuzzy matching) -----
GET {{searchBaseUrl}}/search?q=plage&page=0&size=10

### ----- Full-text search: "Casamance" -----
GET {{searchBaseUrl}}/search?q=Casamance&page=0&size=10

### ----- Fuzzy search: "Sain-Loui" (with typo ‚Üí should match Saint-Louis!) -----
GET {{searchBaseUrl}}/search?q=Sain-Loui&page=0&size=10

### ----- Fuzzy search: "aventurr" (typo ‚Üí should match Aventure!) -----
GET {{searchBaseUrl}}/search?q=aventurr&page=0&size=10

### ----- Search by destination country: "S√©n√©gal" -----
GET {{searchBaseUrl}}/search?q=S√©n√©gal&page=0&size=10

### ----- Search by activity: "pirogue" -----
GET {{searchBaseUrl}}/search?q=pirogue&page=0&size=10

### =============================================================
### FILTERED SEARCH
### =============================================================

### ----- Filter by price: max 500,000 CFA -----
GET {{searchBaseUrl}}/search?maxPrice=500000&page=0&size=10

### ----- Filter by price: min 600,000 CFA -----
GET {{searchBaseUrl}}/search?minPrice=600000&page=0&size=10

### ----- Filter by price range: 400,000 - 500,000 CFA -----
GET {{searchBaseUrl}}/search?minPrice=400000&maxPrice=500000&page=0&size=10

### ----- Filter by departure date: from May 2026 -----
GET {{searchBaseUrl}}/search?fromDate=2026-05-01&page=0&size=10

### ----- Combined: search "plage" + max 500k CFA -----
GET {{searchBaseUrl}}/search?q=plage&maxPrice=500000&page=0&size=10

### ----- Combined: search "for√™t" + from May 2026 + price range -----
GET {{searchBaseUrl}}/search?q=for√™t&fromDate=2026-05-01&minPrice=500000&maxPrice=700000&page=0&size=10

### =============================================================
### GET BY ID
### =============================================================

### ----- Get indexed travel by ID -----
GET {{searchBaseUrl}}/search/{{travelId1}}

### ----- Get second travel by ID -----
GET {{searchBaseUrl}}/search/{{travelId2}}

### =============================================================
### ERROR SCENARIOS
### =============================================================

### ----- Get non-existent document (should fail 404) -----
GET {{searchBaseUrl}}/search/00000000-0000-0000-0000-000000000000

### ----- Empty search results -----
GET {{searchBaseUrl}}/search?q=nonexistenttravelxyz123&page=0&size=10

### =============================================================
### STEP 4: UPDATE & DELETE (test re-indexing & removal)
### =============================================================

### ----- Update Travel 1 (triggers TravelUpdatedEvent ‚Üí re-indexing) -----
PUT {{travelBaseUrl}}/travels/{{travelId1}}
Authorization: Bearer {{managerToken}}
Content-Type: application/json

{
    "title": "Escapade √† Saint-Louis - Edition 2026",
    "price": 475000.0
}

### ‚è≥ Wait ~1s then search again ‚Äî should show updated title & price
GET {{searchBaseUrl}}/search?q=Edition%202026&page=0&size=10

### ----- Cancel Travel 2 (triggers TravelDeletedEvent ‚Üí removed from index) -----
POST {{travelBaseUrl}}/travels/{{travelId2}}/cancel
Authorization: Bearer {{managerToken}}

### ‚è≥ Wait ~1s then search again ‚Äî Casamance should be gone
GET {{searchBaseUrl}}/search?q=Casamance&page=0&size=10

### =============================================================
### SWAGGER UI
### =============================================================
### Open http://localhost:8085/swagger-ui.html in your browser
